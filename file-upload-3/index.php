<?php
    // error_reporting(0);

    // Create folder for each user
    $dir = './upload';
    if ( !file_exists($dir) )
        mkdir($dir);

    if(isset($_GET["debug"])) die(highlight_file(__FILE__));
    if(isset($_FILES["file"])) {
        $error = '';
        $success = '';
        try {
            $mime_type = $_FILES["file"]["type"];
            if (!in_array($mime_type, ["image/jpeg", "image/png", "image/gif"])) {
                die("File tải lên bắt buộc phải là ảnh");
            }
            $file = $dir . "/" . $_FILES["file"]["name"];
            move_uploaded_file($_FILES["file"]["tmp_name"], $file);
            $success = 'Tải tệp lên thành công tại đường dẫn: <a href="' . $file . '">' . $file . ' </a><br>';
        } catch(Exception $e) {
            $error = $e->getMessage();
        }
    }
?>

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>File Upload 3</title>

        <!-- This is for UI only -->
        <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css" integrity="sha512-P5MgMn1jBN01asBgU0z60Qk4QxiXo86+wlFahKrsQf37c9cro517WzVSPPV1tDKzhku2iJ2FVgL67wG03SGnNA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    </head>
    <body>
        <br/>
        <br/>
        <h1 class="display-4 text-center">File upload vulnerability</h1>
        <h4 class="display-4 text-center mb-4">Mức độ 3</h4>


        <br/>
        <div class="container">
            <form method="post" enctype="multipart/form-data">
            <div class="d-flex">
                <h4 class="mr-3">Chọn file để tải lên:<h4>
            
                <input type="file" name="file" id="file" required>
                <input type="submit" class="btn btn-info ml-5">
            </div>
            </form>
            <?php
                if (isset($error)) {
                    echo '<span style="color:red">' . $error . '</span>';
                }

                if (isset($success)) {
                    echo '<span style="color:green">' . $success . '</span>';
                }
            ?>
        </div>

    </body>

</html>
